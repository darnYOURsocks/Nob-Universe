<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>λ-Δ-ψ Trajectory</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0f1116; color: #e8ecf0; }
    #plot { background: #1b1f29; border: 1px solid #384050; }
    #controls { margin-top: 10px; }
    .legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .legend span { padding: 4px 8px; border-radius: 4px; color: #0f1116; font-weight: bold; }
  </style>
</head>
<body>
  <h2>λ-Δ-ψ Symbolic Trajectory</h2>
  <canvas id="plot" width="900" height="600"></canvas>
  <div id="controls">
    <label>Time step: <input type="range" id="time" min="0" max="1" value="1" /></label>
    <span id="time-label"></span>
  </div>
  <div class="legend" id="legend"></div>

  <script>
    const canvas = document.getElementById('plot');
    const ctx = canvas.getContext('2d');
    const timeSlider = document.getElementById('time');
    const timeLabel = document.getElementById('time-label');
    const legend = document.getElementById('legend');

    const colors = {
      'SU-TI': '#6ee7ff',
      'ME-TI': '#7dd3fc',
      'ME-ME': '#a5b4fc',
      'FRAG-Δ': '#fca5a5',
      'THE_ONE': '#fde047',
      'THE_MANY': '#86efac',
      'COH-REBUILD': '#c084fc',
      'default': '#e5e7eb'
    };

    const fetchLogs = async () => {
      try {
        const res = await fetch('../data/run_logs.json');
        const data = await res.json();
        return data.trajectory || [];
      } catch (err) {
        console.error('Could not load run logs', err);
        return [];
      }
    };

    const project = (x, y, z, angle) => {
      const cos = Math.cos(angle);
      const sin = Math.sin(angle);
      // simple rotation around vertical axis followed by perspective divide
      const rx = cos * x - sin * z;
      const rz = sin * x + cos * z;
      const depth = 4 / (4 + rz);
      return {
        x: canvas.width / 2 + rx * 150 * depth,
        y: canvas.height / 2 - y * 150 * depth,
        depth
      };
    };

    const drawAxes = () => {
      ctx.strokeStyle = '#2f3748';
      ctx.lineWidth = 1;
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      ctx.beginPath();
      ctx.moveTo(centerX - 200, centerY);
      ctx.lineTo(centerX + 200, centerY);
      ctx.moveTo(centerX, centerY - 200);
      ctx.lineTo(centerX, centerY + 200);
      ctx.stroke();
      ctx.fillStyle = '#cbd5e1';
      ctx.fillText('λ', centerX + 205, centerY - 4);
      ctx.fillText('Δ', centerX + 4, centerY - 205);
      ctx.fillText('ψ depth', centerX + 6, centerY + 215);
    };

    const drawLegend = (labels) => {
      legend.innerHTML = '';
      labels.forEach(label => {
        const span = document.createElement('span');
        span.textContent = label;
        span.style.background = colors[label] || colors.default;
        legend.appendChild(span);
      });
    };

    const render = (trajectory, angle = 0) => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawAxes();
      const cutoff = parseInt(timeSlider.value, 10);
      timeLabel.textContent = `${cutoff + 1} / ${trajectory.length}`;

      trajectory.slice(0, cutoff + 1).forEach((entry, idx) => {
        const { x, y, depth } = project(entry.lambda, entry.delta, entry.psi, angle + idx * 0.02);
        const color = colors[entry.label] || colors.default;
        const radius = Math.max(2, 5 * depth);
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.fill();
      });
    };

    (async () => {
      const trajectory = await fetchLogs();
      if (!trajectory.length) {
        ctx.fillStyle = '#f87171';
        ctx.fillText('No trajectory found. Run simulation/run_pipeline.py first.', 20, 50);
        return;
      }
      timeSlider.max = trajectory.length - 1;
      timeSlider.value = trajectory.length - 1;
      drawLegend([...new Set(trajectory.map(t => t.label))]);
      let angle = 0;
      const animate = () => {
        angle += 0.01;
        render(trajectory, angle);
        requestAnimationFrame(animate);
      };
      animate();
      timeSlider.addEventListener('input', () => render(trajectory, angle));
    })();
  </script>
</body>
</html>
